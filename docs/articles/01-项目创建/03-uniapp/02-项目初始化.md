# Pinia åˆå§‹åŒ–

ç”¨æ³•ä¸ Vue3 å®Œå…¨ä¸€è‡´ï¼Œä»…éœ€é€‚é…å…¼å®¹æ€§é—®é¢˜ã€‚

### æŒä¹…åŒ–å­˜å‚¨æ’ä»¶

å®‰è£…æŒä¹…åŒ–å­˜å‚¨æ’ä»¶ï¼š [pinia-plugin-persistedstate](https://prazdevs.github.io/pinia-plugin-persistedstate/zh/guide/config.html#storage)

```bash
pnpm i pinia pinia-plugin-persistedstate
```

æ’ä»¶é»˜è®¤ä½¿ç”¨ `localStorage` å®ç°æŒä¹…åŒ–ï¼Œå°ç¨‹åºç«¯ä¸å…¼å®¹ï¼Œéœ€è¦æ›¿æ¢æŒä¹…åŒ– APIã€‚

ä»¥åŠå®‰è£…å¿…è¦çš„ä¾èµ–ï¼Œå¦åˆ™ä¼šå¯¼è‡´æ„å»ºmp-weixinæŠ¥é”™ï¼š

```
pnpm add destr deep-pick-omit -D
```



### å®˜æ–¹æ–‡æ¡£

åœ¨æ·±å…¥ç ”ç©¶æ ¸å¿ƒæ¦‚å¿µä¹‹å‰ï¼Œæˆ‘ä»¬å¾—çŸ¥é“ Store æ˜¯ç”¨ `defineStore()` å®šä¹‰çš„ï¼Œå®ƒçš„ç¬¬ä¸€ä¸ªå‚æ•°è¦æ±‚æ˜¯ä¸€ä¸ª**ç‹¬ä¸€æ— äºŒçš„**åå­—ï¼š

```ts
import { defineStore } from 'pinia'

//  `defineStore()` çš„è¿”å›å€¼çš„å‘½åæ˜¯è‡ªç”±çš„
// ä½†æœ€å¥½å«æœ‰ store çš„åå­—ï¼Œä¸”ä»¥ `use` å¼€å¤´ï¼Œä»¥ `Store` ç»“å°¾ã€‚
// (æ¯”å¦‚ `useUserStore`ï¼Œ`useCartStore`ï¼Œ`useProductStore`)
// ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä½ çš„åº”ç”¨ä¸­ Store çš„å”¯ä¸€ IDã€‚
export const useAlertsStore = defineStore('alerts', {
  // å…¶ä»–é…ç½®...
})
```

è¿™ä¸ª**åå­—** ï¼Œä¹Ÿè¢«ç”¨ä½œ *id* ï¼Œæ˜¯å¿…é¡»ä¼ å…¥çš„ï¼Œ Pinia å°†ç”¨å®ƒæ¥è¿æ¥ store å’Œ devtoolsã€‚ä¸ºäº†å…»æˆä¹ æƒ¯æ€§çš„ç”¨æ³•ï¼Œå°†è¿”å›çš„å‡½æ•°å‘½åä¸º *use...* æ˜¯ä¸€ä¸ªç¬¦åˆç»„åˆå¼å‡½æ•°é£æ ¼çš„çº¦å®šã€‚

`defineStore()` çš„ç¬¬äºŒä¸ªå‚æ•°å¯æ¥å—ä¸¤ç±»å€¼ï¼šSetup å‡½æ•°æˆ– Option å¯¹è±¡ã€‚

## Option Store

ä¸ Vue çš„é€‰é¡¹å¼ API ç±»ä¼¼ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä¼ å…¥ä¸€ä¸ªå¸¦æœ‰ `state`ã€`actions` ä¸ `getters` å±æ€§çš„ Option å¯¹è±¡ï¼š

```ts
export const useCounterStore = defineStore('counter', {
  state: () => ({ count: 0, name: 'Eduardo' }),
  getters: {
    doubleCount: (state) => state.count * 2,
  },
  actions: {
    increment() {
      this.count++
    },
  },
})
```

ä½ å¯ä»¥è®¤ä¸º `state` æ˜¯ store çš„æ•°æ® (`data`)ï¼Œ`getters` æ˜¯ store çš„è®¡ç®—å±æ€§ (`computed`)ï¼Œè€Œ `actions` åˆ™æ˜¯æ–¹æ³• (`methods`)ã€‚

ä¸ºæ–¹ä¾¿ä¸Šæ‰‹ä½¿ç”¨ï¼ŒOption Store åº”å°½å¯èƒ½ç›´è§‚ç®€å•ã€‚

## Setup Store

ä¹Ÿå­˜åœ¨å¦ä¸€ç§å®šä¹‰ store çš„å¯ç”¨è¯­æ³•ã€‚ä¸ Vue ç»„åˆå¼ API çš„ [setup å‡½æ•°](https://cn.vuejs.org/api/composition-api-setup.html) ç›¸ä¼¼ï¼Œæˆ‘ä»¬å¯ä»¥ä¼ å…¥ä¸€ä¸ªå‡½æ•°ï¼Œè¯¥å‡½æ•°å®šä¹‰äº†ä¸€äº›å“åº”å¼å±æ€§å’Œæ–¹æ³•ï¼Œå¹¶ä¸”è¿”å›ä¸€ä¸ªå¸¦æœ‰æˆ‘ä»¬æƒ³æš´éœ²å‡ºå»çš„å±æ€§å’Œæ–¹æ³•çš„å¯¹è±¡ã€‚

```ts
export const useCounterStore = defineStore('counter', () => {
  const count = ref(0)
  const name = ref('Eduardo')
  const doubleCount = computed(() => count.value * 2)
  function increment() {
    count.value++
  }

  return { count, name, doubleCount, increment }
})
```

åœ¨ *Setup Store* ä¸­ï¼š

- `ref()` å°±æ˜¯ `state` å±æ€§
- `computed()` å°±æ˜¯ `getters`
- `function()` å°±æ˜¯ `actions`

æ³¨æ„ï¼Œè¦è®© pinia æ­£ç¡®è¯†åˆ« `state`ï¼Œä½ **å¿…é¡»**åœ¨ setup store ä¸­è¿”å› **`state` çš„æ‰€æœ‰å±æ€§**ã€‚è¿™æ„å‘³ç€ï¼Œä½ ä¸èƒ½åœ¨ store ä¸­ä½¿ç”¨**ç§æœ‰**å±æ€§ã€‚ä¸å®Œæ•´è¿”å›ä¼šå½±å“ [SSR](https://pinia.vuejs.org/zh/cookbook/composables.html) ï¼Œå¼€å‘å·¥å…·å’Œå…¶ä»–æ’ä»¶çš„æ­£å¸¸è¿è¡Œã€‚

Setup store æ¯” [Option Store](https://pinia.vuejs.org/zh/core-concepts/#option-stores) å¸¦æ¥äº†æ›´å¤šçš„çµæ´»æ€§ï¼Œå› ä¸ºä½ å¯ä»¥åœ¨ä¸€ä¸ª store å†…åˆ›å»ºä¾¦å¬å™¨ï¼Œå¹¶è‡ªç”±åœ°ä½¿ç”¨ä»»ä½•[ç»„åˆå¼å‡½æ•°](https://cn.vuejs.org/guide/reusability/composables.html#composables)ã€‚ä¸è¿‡ï¼Œè¯·è®°ä½ï¼Œä½¿ç”¨ç»„åˆå¼å‡½æ•°ä¼šè®© SSR å˜å¾—æ›´åŠ å¤æ‚ã€‚

Setup store ä¹Ÿå¯ä»¥ä¾èµ–äºå…¨å±€**æä¾›**çš„å±æ€§ï¼Œæ¯”å¦‚è·¯ç”±ã€‚ä»»ä½•[åº”ç”¨å±‚é¢æä¾›](https://vuejs.org/api/application.html#app-provide)çš„å±æ€§éƒ½å¯ä»¥åœ¨ store ä¸­ä½¿ç”¨ `inject()` è®¿é—®ï¼Œå°±åƒåœ¨ç»„ä»¶ä¸­ä¸€æ ·ï¼š

```ts
import { inject } from 'vue'
import { useRoute } from 'vue-router'
import { defineStore } from 'pinia'

export const useSearchFilters = defineStore('search-filters', () => {
  const route = useRoute()
  // è¿™é‡Œå‡å®š `app.provide('appProvided', 'value')` å·²ç»è°ƒç”¨è¿‡
  const appProvided = inject('appProvided')

  // ...

  return {
    // ...
  }
})
```

::: denger WARNING

ä¸è¦è¿”å›åƒ `route` æˆ– `appProvided` (ä¸Šä¾‹ä¸­)ä¹‹ç±»çš„å±æ€§ï¼Œå› ä¸ºå®ƒä»¬ä¸å±äº storeï¼Œè€Œä¸”ä½ å¯ä»¥åœ¨ç»„ä»¶ä¸­ç›´æ¥ç”¨ `useRoute()` å’Œ `inject('appProvided')` è®¿é—®ã€‚

::: 

## ä½ åº”è¯¥é€‰ç”¨å“ªç§è¯­æ³•ï¼Ÿ

å’Œ[åœ¨ Vue ä¸­å¦‚ä½•é€‰æ‹©ç»„åˆå¼ API ä¸é€‰é¡¹å¼ API](https://cn.vuejs.org/guide/introduction.html#which-to-choose) ä¸€æ ·ï¼Œé€‰æ‹©ä½ è§‰å¾—æœ€èˆ’æœçš„é‚£ä¸€ä¸ªå°±å¥½ã€‚ä¸¤ç§è¯­æ³•éƒ½æœ‰å„è‡ªçš„ä¼˜åŠ¿å’ŒåŠ£åŠ¿ã€‚Option Store æ›´å®¹æ˜“ä½¿ç”¨ï¼Œè€Œ Setup Store æ›´çµæ´»å’Œå¼ºå¤§ã€‚å¦‚æœä½ æƒ³æ·±å…¥äº†è§£ä¸¤è€…ä¹‹é—´çš„åŒºåˆ«ï¼Œè¯·æŸ¥çœ‹ Mastering Pinia ä¸­çš„ [Option Stores vs Setup Stores ç« èŠ‚](https://masteringpinia.com/lessons/when-to-choose-one-syntax-over-the-other)ã€‚

## ä½¿ç”¨ Store

è™½ç„¶æˆ‘ä»¬å‰é¢å®šä¹‰äº†ä¸€ä¸ª storeï¼Œä½†åœ¨æˆ‘ä»¬ä½¿ç”¨ `<script setup>` è°ƒç”¨ `useStore()`(æˆ–è€…ä½¿ç”¨ `setup()` å‡½æ•°ï¼Œ**åƒæ‰€æœ‰çš„ç»„ä»¶é‚£æ ·**) ä¹‹å‰ï¼Œstore å®ä¾‹æ˜¯ä¸ä¼šè¢«åˆ›å»ºçš„ï¼š

```vue
<script setup>
import { useCounterStore } from '@/stores/counter'
// åœ¨ç»„ä»¶å†…éƒ¨çš„ä»»ä½•åœ°æ–¹å‡å¯ä»¥è®¿é—®å˜é‡ `store` âœ¨
const store = useCounterStore()
</script>
```

TIP

å¦‚æœä½ è¿˜ä¸ä¼šä½¿ç”¨ `setup` ç»„ä»¶ï¼Œ[ä½ ä¹Ÿå¯ä»¥é€šè¿‡**æ˜ å°„è¾…åŠ©å‡½æ•°**æ¥ä½¿ç”¨ Pinia](https://pinia.vuejs.org/zh/cookbook/options-api.html)ã€‚

ä½ å¯ä»¥å®šä¹‰ä»»æ„å¤šçš„ storeï¼Œä½†ä¸ºäº†è®©ä½¿ç”¨ pinia çš„ç›Šå¤„æœ€å¤§åŒ–(æ¯”å¦‚å…è®¸æ„å»ºå·¥å…·è‡ªåŠ¨è¿›è¡Œä»£ç åˆ†å‰²ä»¥åŠ TypeScript æ¨æ–­)ï¼Œ**ä½ åº”è¯¥åœ¨ä¸åŒçš„æ–‡ä»¶ä¸­å»å®šä¹‰ store**ã€‚

ä¸€æ—¦ store è¢«å®ä¾‹åŒ–ï¼Œä½ å¯ä»¥ç›´æ¥è®¿é—®åœ¨ store çš„ `state`ã€`getters` å’Œ `actions` ä¸­å®šä¹‰çš„ä»»ä½•å±æ€§ã€‚æˆ‘ä»¬å°†åœ¨åç»­ç« èŠ‚ç»§ç»­äº†è§£è¿™äº›ç»†èŠ‚ï¼Œç›®å‰è‡ªåŠ¨è¡¥å…¨å°†å¸®åŠ©ä½ ä½¿ç”¨ç›¸å…³å±æ€§ã€‚

è¯·æ³¨æ„ï¼Œ`store` æ˜¯ä¸€ä¸ªç”¨ `reactive` åŒ…è£…çš„å¯¹è±¡ï¼Œè¿™æ„å‘³ç€ä¸éœ€è¦åœ¨ getters åé¢å†™ `.value`ã€‚å°±åƒ `setup` ä¸­çš„ `props` ä¸€æ ·ï¼Œ**æˆ‘ä»¬ä¸èƒ½å¯¹å®ƒè¿›è¡Œè§£æ„**ï¼š

```ts
<script setup>
import { useCounterStore } from '@/stores/counter'
import { computed } from 'vue'

const store = useCounterStore()
// âŒ ä¸‹é¢è¿™éƒ¨åˆ†ä»£ç ä¸ä¼šç”Ÿæ•ˆï¼Œå› ä¸ºå®ƒçš„å“åº”å¼è¢«ç ´åäº†
// ä¸ reactive ç›¸åŒ: https://vuejs.org/guide/essentials/reactivity-fundamentals.html#limitations-of-reactive
const { name, doubleCount } = store
name // å°†ä¼šä¸€ç›´æ˜¯ "Eduardo" //
doubleCount // å°†ä¼šä¸€ç›´æ˜¯ 0 //
setTimeout(() => {
  store.increment()
}, 1000)
// âœ… è€Œè¿™ä¸€éƒ¨åˆ†ä»£ç å°±ä¼šç»´æŒå“åº”å¼
// ğŸ’¡ åœ¨è¿™é‡Œä½ ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ `store.doubleCount`
const doubleValue = computed(() => store.doubleCount)
</script>
```

## ä» Store è§£æ„

ä¸ºäº†ä» store ä¸­æå–å±æ€§æ—¶ä¿æŒå…¶å“åº”æ€§ï¼Œä½ éœ€è¦ä½¿ç”¨ `storeToRefs()`ã€‚å®ƒå°†ä¸ºæ¯ä¸€ä¸ªå“åº”å¼å±æ€§åˆ›å»ºå¼•ç”¨ã€‚å½“ä½ åªä½¿ç”¨ store çš„çŠ¶æ€è€Œä¸è°ƒç”¨ä»»ä½• action æ—¶ï¼Œå®ƒä¼šéå¸¸æœ‰ç”¨ã€‚è¯·æ³¨æ„ï¼Œä½ å¯ä»¥ç›´æ¥ä» store ä¸­è§£æ„ actionï¼Œå› ä¸ºå®ƒä»¬ä¹Ÿè¢«ç»‘å®šåˆ° store ä¸Šï¼š

```ts
<script setup>
import { storeToRefs } from 'pinia'
import { useCounterStore } from '@/stores/counter' // éœ€è¦å¼•å…¥ store
const store = useCounterStore()
// `name` å’Œ `doubleCount` éƒ½æ˜¯å“åº”å¼å¼•ç”¨
// ä¸‹é¢çš„ä»£ç åŒæ ·ä¼šæå–é‚£äº›æ¥è‡ªæ’ä»¶çš„å±æ€§çš„å“åº”å¼å¼•ç”¨
// ä½†æ˜¯ä¼šè·³è¿‡æ‰€æœ‰çš„ action æˆ–è€…éå“åº”å¼ï¼ˆé ref æˆ–è€… é reactiveï¼‰çš„å±æ€§
const { name, doubleCount } = storeToRefs(store)
// åä¸º increment çš„ action å¯ä»¥è¢«è§£æ„
const { increment } = store
</script>
```



# Pinia é…ç½®

## åŸºæœ¬é…ç½®

::: code-group

```ts [store/modules/members.ts]
import { defineStore } from 'pinia'
import { ref } from 'vue'

// å®šä¹‰ Store
export const useMemberStore = defineStore(
  'member',
  () => {
    // ä¼šå‘˜ä¿¡æ¯
    const profile = ref<any>()

    // ä¿å­˜ä¼šå‘˜ä¿¡æ¯ï¼Œç™»å½•æ—¶ä½¿ç”¨
    const setProfile = (val: any) => {
      profile.value = val
    }

    // æ¸…ç†ä¼šå‘˜ä¿¡æ¯ï¼Œé€€å‡ºæ—¶ä½¿ç”¨
    const clearProfile = () => {
      profile.value = undefined
    }

    // è®°å¾— return
    return {
      profile,
      setProfile,
      clearProfile,
    }
  },
  // TODO: æŒä¹…åŒ–
  {
    persist: true,
  },
)
```

``` ts [store/index.ts]
import { createPinia } from 'pinia'
import persist from 'pinia-plugin-persistedstate'

// åˆ›å»º pinia å®ä¾‹
const pinia = createPinia()
// ä½¿ç”¨æŒä¹…åŒ–å­˜å‚¨æ’ä»¶
pinia.use(persist)

// é»˜è®¤å¯¼å‡ºï¼Œç»™ main.ts ä½¿ç”¨
export default pinia

// æ¨¡å—ç»Ÿä¸€å¯¼å‡º
export * from './modules/member'
```

``` ts [main.ts]
import { createSSRApp } from 'vue'
import pinia from './stores'

import App from './App.vue'
export function createApp() {
  const app = createSSRApp(App)

  app.use(pinia)
  return {
    app,
  }
}
```

:::

## å¤šç«¯å…¼å®¹

**ç½‘é¡µç«¯æŒä¹…åŒ– API**

```
// ç½‘é¡µç«¯API
localStorage.setItem()
localStorage.getItem()
```

**å¤šç«¯æŒä¹…åŒ– API**

```
// å…¼å®¹å¤šç«¯API
uni.setStorageSync()
uni.getStorageSync()
```

**å‚è€ƒä»£ç **

```ts
// stores/modules/member.ts
export const useMemberStore = defineStore(
  'member',
  () => {
    //â€¦çœç•¥
  },
  {
    // é…ç½®æŒä¹…åŒ–
    persist: {
      // è°ƒæ•´ä¸ºå…¼å®¹å¤šç«¯çš„API
      storage: {
        setItem(key, value) {
          uni.setStorageSync(key, value) 
        },
        getItem(key) {
          return uni.getStorageSync(key) 
        },
      },
    },
  },
)
```

# æ‹¦æˆªå™¨&è¯·æ±‚å‡½æ•°

## æ‹¦æˆªå™¨ - åˆ›å»º http.ts æ¨¡å—

**uniapp æ‹¦æˆªå™¨**ï¼š [uni.addInterceptor](https://uniapp.dcloud.net.cn/api/interceptor.html)

**æ¥å£è¯´æ˜**ï¼š[æ¥å£æ–‡æ¡£](https://www.apifox.cn/apidoc/shared-0e6ee326-d646-41bd-9214-29dbf47648fa/doc-1521513)

å®ç°éœ€æ±‚

1. æ‹¼æ¥åŸºç¡€åœ°å€
2. è®¾ç½®è¶…æ—¶æ—¶é—´
3. æ·»åŠ è¯·æ±‚å¤´æ ‡è¯†
4. æ·»åŠ  token

src/utils/http.ts

```ts
// src/utils/http.ts

import { useMemberStore } from '@/stores'

// è¯·æ±‚åŸºåœ°å€
const baseURL = 'https://pcapi-xiaotuxian-front-devtest.itheima.net'

// æ‹¦æˆªå™¨é…ç½®
const httpInterceptor = {
  // æ‹¦æˆªå‰è§¦å‘
  invoke(options: UniApp.RequestOptions) {
    // 1. é http å¼€å¤´éœ€æ‹¼æ¥åœ°å€
    if (!options.url.startsWith('http')) {
      options.url = baseURL + options.url
    }
    // 2. è¯·æ±‚è¶…æ—¶
    options.timeout = 10000
    // 3. æ·»åŠ å°ç¨‹åºç«¯è¯·æ±‚å¤´æ ‡è¯†
    options.header = {
      'source-client': 'miniapp',
      ...options.header,
    }
    // 4. æ·»åŠ  token è¯·æ±‚å¤´æ ‡è¯†
    const memberStore = useMemberStore()
    const token = memberStore.profile?.token
    if (token) {
      options.header.Authorization = token
    }
  },
}

// æ‹¦æˆª request è¯·æ±‚
uni.addInterceptor('request', httpInterceptor)
// æ‹¦æˆª uploadFile æ–‡ä»¶ä¸Šä¼ 
uni.addInterceptor('uploadFile', httpInterceptor)
```



## å°è£… Promise è¯·æ±‚å‡½æ•°

å®ç°éœ€æ±‚

1. è¿”å› Promise å¯¹è±¡ï¼Œç”¨äºå¤„ç†è¿”å›å€¼ç±»å‹
2. æˆåŠŸ resolve
   1. æå–æ•°æ®
   2. æ·»åŠ æ³›å‹
3. å¤±è´¥ reject
   1. 401 é”™è¯¯
   2. å…¶ä»–é”™è¯¯
   3. ç½‘ç»œé”™è¯¯

**å‚è€ƒä»£ç **

```ts
/**
 * è¯·æ±‚å‡½æ•°
 * @param  UniApp.RequestOptions
 * @returns Promise
 *  1. è¿”å› Promise å¯¹è±¡ï¼Œç”¨äºå¤„ç†è¿”å›å€¼ç±»å‹
 *  2. è·å–æ•°æ®æˆåŠŸ
 *    2.1 æå–æ ¸å¿ƒæ•°æ® res.data
 *    2.2 æ·»åŠ ç±»å‹ï¼Œæ”¯æŒæ³›å‹
 *  3. è·å–æ•°æ®å¤±è´¥
 *    3.1 401é”™è¯¯  -> æ¸…ç†ç”¨æˆ·ä¿¡æ¯ï¼Œè·³è½¬åˆ°ç™»å½•é¡µ
 *    3.2 å…¶ä»–é”™è¯¯ -> æ ¹æ®åç«¯é”™è¯¯ä¿¡æ¯è½»æç¤º
 *    3.3 ç½‘ç»œé”™è¯¯ -> æç¤ºç”¨æˆ·æ¢ç½‘ç»œ
 */
type Data<T> = {
  code: string
  msg: string
  result: T
}
// 2.2 æ·»åŠ ç±»å‹ï¼Œæ”¯æŒæ³›å‹
export const http = <T>(options: UniApp.RequestOptions) => {
  // 1. è¿”å› Promise å¯¹è±¡
  return new Promise<Data<T>>((resolve, reject) => {
    uni.request({
      ...options,
      // å“åº”æˆåŠŸ
      success(res) {
        // çŠ¶æ€ç  2xxï¼Œå‚è€ƒ axios çš„è®¾è®¡
        if (res.statusCode >= 200 && res.statusCode < 300) {
          // 2.1 æå–æ ¸å¿ƒæ•°æ® res.data
          resolve(res.data as Data<T>)
        } else if (res.statusCode === 401) {
          // 401é”™è¯¯  -> æ¸…ç†ç”¨æˆ·ä¿¡æ¯ï¼Œè·³è½¬åˆ°ç™»å½•é¡µ
          const memberStore = useMemberStore()
          memberStore.clearProfile()
          uni.navigateTo({ url: '/pages/login/login' })
          reject(res)
        } else {
          // å…¶ä»–é”™è¯¯ -> æ ¹æ®åç«¯é”™è¯¯ä¿¡æ¯è½»æç¤º
          uni.showToast({
            icon: 'none',
            title: (res.data as Data<T>).msg || 'è¯·æ±‚é”™è¯¯',
          })
          reject(res)
        }
      },
      // å“åº”å¤±è´¥
      fail(err) {
        uni.showToast({
          icon: 'none',
          title: 'ç½‘ç»œé”™è¯¯ï¼Œæ¢ä¸ªç½‘ç»œè¯•è¯•',
        })
        reject(err)
      },
    })
  })
}
```



## è®¾ç½®ç±»å‹

![image-20251004161705373](../../../public/image-è®¾ç½®ç±»å‹.png)

# è‡ªå®šä¹‰å¯¼èˆªæ 

## å‰ç½®

```json
// src/pages.json
{
  "path": "pages/index/index",
  "style": {
    "navigationStyle": "custom", // éšè—é»˜è®¤å¯¼èˆª
    "navigationBarTextStyle": "white",
    "navigationBarTitleText": "é¦–é¡µ"
  }
}
```

## å®‰å…¨åŒºåŸŸçš„æ¦‚å¿µ

ä¸åŒæ‰‹æœºçš„å®‰å…¨åŒºåŸŸä¸åŒï¼Œé€‚é…å®‰å…¨åŒºåŸŸèƒ½é˜²æ­¢é¡µé¢é‡è¦å†…å®¹è¢«é®æŒ¡ã€‚

å¯é€šè¿‡ `uni.getSystemInfoSync()` è·å–å±å¹•è¾¹ç•Œåˆ°å®‰å…¨åŒºçš„è·ç¦»ã€‚

![img](../../../public/image-ç§»åŠ¨ç«¯å®‰å…¨åŒºåŸŸ.png)

```ts
// è·å–å±å¹•è¾¹ç•Œåˆ°å®‰å…¨åŒºåŸŸè·ç¦»
const { safeAreaInsets } = uni.getSystemInfoSync
```

å¯èƒ½éœ€è¦åœ¨ eslint é…ç½®ä¸­å£°æ˜ï¼š

```json
{
  files: ['**/*.{js,mjs,cjs,ts,mts,cts,vue}'],
  plugins: { js },
  extends: ['js/recommended'],
  // å¢åŠ  uni: 'readonly'
  languageOptions: { globals: { ...globals.browser, ...globals.node, uni: 'readonly' } },
},
```

å®Œæ•´çš„ç»„ä»¶ä»£ç ï¼š

```
```



# iconfont å›¾æ ‡

é¦–å…ˆï¼Œä¸‹è½½æ‰€éœ€è¦çš„ iconfont æ–‡ä»¶ï¼š

ç„¶åï¼Œåˆ°é¡¹ç›®æ ¹ç»„ä»¶ App.vue ä¸­æ·»åŠ ä»¥ä¸‹é…ç½®ï¼š

```vue {13-37}
<script setup lang="ts">
import { onLaunch, onShow, onHide } from '@dcloudio/uni-app'
onLaunch(() => {
  console.log('App Launch')
})
onShow(() => {
  console.log('App Show') 
})
onHide(() => {
  console.log('App Hide') 
})
</script>
<style>
/* å­—ä½“å®šä¹‰å¿…é¡»åœ¨æ‰€æœ‰æ ·å¼ä¹‹å‰ */ 
@font-face { 
  font-family: 'iconfont';
  src:
    url('/static/fonts/iconfont.woff2') format('woff2'),
    url('/static/fonts/iconfont.woff') format('woff'),
    url('/static/fonts/iconfont.ttf') format('truetype');
  font-weight: normal;
  font-style: normal;
  font-display: block;
  /* æ·»åŠ è¿™ä¸€è¡Œ */
}

/* åŸºç¡€å›¾æ ‡æ ·å¼ */
.iconfont {
  font-family: 'iconfont' !important;
  font-size: 16px;
  font-style: normal;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  display: inline-block;
  /* æ·»åŠ è¿™ä¸€è¡Œ */
}
</style>

```

ä½¿ç”¨ï¼š

```vue
<template>
  <view
    class="navbar"
    :style="{ paddingTop: safeAreaInsets?.top + 'px' }"
  >
    <!-- logoæ–‡å­— -->
    <view class="logo">
      <image
        class="logo-image"
        src="@/static/images/yun-logo.png"
      ></image>
      <text class="logo-image-text">äº‘å³°å†œæœ</text>
      <!-- <text class="logo-text">å¿«æ· Â· æ˜“ç”¨ Â· é«˜æ•ˆ</text> -->
    </view>

    <!-- æœç´¢æ¡ -->
    <!-- <view class="search">
      <text class="icon-search">æœç´¢å•†å“</text>
      <text class="icon-scan"></text>
    </view> -->

    <!-- navBar-bottom -->
    <view class="navbar-bottom">
      <div class="tianqi">
        <text class="tianqi-temp">28Â°</text>
        <text class="tianqi-desc">æ™´</text>
        <image
          class="tianqi-icon"
          src="@/static/icon/å¤©æ°”-æ™´.svg"
        ></image>
      </div>
      <div class="location">
        <text class="iconfont location-icon">&#xe790;</text>
        <text class="info-text">ç‰¡ä¸¹åŒº</text>
      </div>
      <div class="shidu">
        <text class="iconfont shidu-icon">&#xe682;</text>
        <text class="info-text">65%</text>
      </div>
      <div class="air">
        <text class="iconfont air-icon">&#xe60e;</text>
        <text class="info-text air-text">è‰¯å¥½</text>
      </div>
    </view>
  </view>
</template>
```



# iconify åœ¨uniapp ä¸­çš„ä½¿ç”¨-é€‚é…å°ç¨‹åº

åœ¨ **uni-appï¼ˆVue3 ç‰ˆæœ¬ï¼‰** ä¸­ä½¿ç”¨ **Iconify å›¾æ ‡ç³»ç»Ÿ** æ˜¯å®Œå…¨å¯è¡Œçš„ï¼Œè€Œä¸”æ¯”å¾ˆå¤šæœ¬åœ°å›¾æ ‡æ–¹æ¡ˆæ›´çµæ´»ï¼ˆæ¯”å¦‚æ”¯æŒä¸Šåƒå¥—å›¾æ ‡åº“ï¼‰ã€‚

ç¬¬ä¸€æ­¥ï¼Œå®‰è£…ä¾èµ–ï¼š

```
pnpm add @iconify/vue
```

ç¬¬äºŒæ­¥ï¼Œé…ç½®æŒ‰éœ€å¼•å…¥ï¼š

éœ€è¦å€ŸåŠ©ï¼š

- ğŸ‘‰ **unplugin-vue-components**
-  ğŸ‘‰ **unplugin-auto-import**

è¿™ä¸¤ä¸ªæ’ä»¶æ˜¯ Vite å®˜æ–¹æ¨èçš„è‡ªåŠ¨å¯¼å…¥æ–¹æ¡ˆï¼š

å‘ä½ï¼šéœ€è¦æŒ‡å®šç‰ˆæœ¬å·ï¼Œå¦åˆ™ä¼šæŠ¥ä¸€äº›å…¼å®¹æ€§é”™è¯¯ï¼š  "unplugin-auto-import": "19",  "unplugin-vue-components": "28",

```
pnpm add -D unplugin-vue-components@28 unplugin-auto-import@19
```

unplugin-vue-components ä¼šç”Ÿæˆ src/components.d.tsï¼Œé‡Œé¢ä¹Ÿä¼šå£°æ˜ `<Icon>`

ç„¶åï¼š`vite.config.ts`

```ts {9-27}
import { defineConfig } from 'vite'
import uni from '@dcloudio/vite-plugin-uni'

import Components from 'unplugin-vue-components/vite'
import AutoImport from 'unplugin-auto-import/vite'

// https://vitejs.dev/config/
export default defineConfig({
  plugins: [
    uni(), // è‡ªåŠ¨å¼•å…¥ vue api (å¯é€‰)
    AutoImport({
      imports: ['vue'],
      dts: 'src/auto-imports.d.ts',
    }),

    // è‡ªåŠ¨æ³¨å†Œç»„ä»¶
    Components({
      dts: 'src/components.d.ts',
      resolvers: [
        // è‡ªåŠ¨å¼•å…¥ Iconify çš„ Icon ç»„ä»¶
        (name) => {
          if (name === 'Icon') {
            return { name: 'Icon', from: '@iconify/vue' }
          }
        },
      ],
    }),
  ],
})
```

ç”±äº **å°ç¨‹åºç¯å¢ƒä¸‹æ— æ³•ç›´æ¥ä½¿ç”¨ Iconify çš„ SVG æ¸²æŸ“**ã€‚

å› æ­¤éœ€è¦ç¬¬ä¸‰æ­¥ï¼šåˆ›å»º `@/utils/iconLoader.ts`

```ts
// src/utils/iconLoader.ts
import { getIconData } from '@iconify/utils/lib/icon-set/get-icon'

// 1. å¯¼å…¥æ‰€æœ‰éœ€è¦çš„å›¾æ ‡é›† (éœ€è¦å®‰è£…)
import { icons as mdiIcons } from '@iconify-json/mdi'
import { icons as phIcons } from '@iconify-json/ph'

// 2. å®šä¹‰å›¾æ ‡æ•°æ®ç±»å‹
export interface IconData {
  body: string      // SVG path æ•°æ®
  width: number     // å›¾æ ‡åŸå§‹å®½åº¦
  height: number    // å›¾æ ‡åŸå§‹é«˜åº¦
}

// 3. é…ç½®æ”¯æŒçš„å›¾æ ‡é›†æ˜ å°„
const iconSets: Record<string, any> = {
  // Material Design Icons - è°·æ­Œ Material Design é£æ ¼
  'mdi': mdiIcons,

  // Phosphor Icons - çµæ´»çš„ä¸€è‡´æ€§å›¾æ ‡
  'ph': phIcons,

}

// 4. å›¾æ ‡é›†ä¿¡æ¯ï¼ˆç”¨äºé”™è¯¯æç¤ºå’Œæ–‡æ¡£ï¼‰
export const iconSetInfo: Record<string, { name: string; count: number }> = {
  'mdi': { name: 'Material Design Icons', count: 7000 },
  'ph': { name: 'Phosphor Icons', count: 6000 },
  'tabler': { name: 'Tabler Icons', count: 4500 },
  'carbon': { name: 'Carbon Icons', count: 2000 },
  'fa6-regular': { name: 'Font Awesome 6 Regular', count: 2000 },
  'fa6-solid': { name: 'Font Awesome 6 Solid', count: 2000 },
  'fa6-brands': { name: 'Font Awesome 6 Brands', count: 2000 },
}

// 5. æ ¸å¿ƒå›¾æ ‡æ•°æ®è·å–å‡½æ•°
export const getIconSVGData = (iconName: string): IconData | null => {
  try {
    // 5.1 è§£æå›¾æ ‡åç§°
    const [prefix, name] = iconName.split(':')

    // 5.2 éªŒè¯åç§°æ ¼å¼
    if (!prefix || !name) {
      console.warn(`ğŸš« å›¾æ ‡åç§°æ ¼å¼é”™è¯¯: "${iconName}"ã€‚æ­£ç¡®æ ¼å¼: "å‰ç¼€:å›¾æ ‡å"`)
      return null
    }

    // 5.3 æŸ¥æ‰¾å¯¹åº”çš„å›¾æ ‡é›†
    const iconSet = iconSets[prefix]
    if (!iconSet) {
      const supportedPrefixes = Object.keys(iconSets).join(', ')
      console.warn(`ğŸš« ä¸æ”¯æŒçš„å›¾æ ‡é›†: "${prefix}"ã€‚æ”¯æŒçš„å›¾æ ‡é›†: ${supportedPrefixes}`)
      return null
    }

    // 5.4 è·å–å›¾æ ‡æ•°æ®
    const iconData = getIconData(iconSet, name)
    if (!iconData) {
      const info = iconSetInfo[prefix]
      console.warn(`ğŸš« å›¾æ ‡ä¸å­˜åœ¨: "${iconName}"ã€‚${info ? `è¯·åœ¨ ${info.name} ä¸­æŸ¥çœ‹å¯ç”¨å›¾æ ‡` : ''}`)
      return null
    }

    // 5.5 éªŒè¯æ•°æ®å®Œæ•´æ€§
    if (!iconData.body || !iconData.width || !iconData.height) {
      console.warn(`ğŸš« å›¾æ ‡æ•°æ®ä¸å®Œæ•´: "${iconName}"`)
      return null
    }

    // 5.6 è¿”å›æ ‡å‡†åŒ–æ•°æ®
    return {
      body: iconData.body,
      width: iconData.width,
      height: iconData.height
    }

  } catch (error) {
    console.error(`ğŸ’¥ è·å–å›¾æ ‡æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯: "${iconName}"`, error)
    return null
  }
}

// 6. æ‰¹é‡è·å–å›¾æ ‡æ•°æ®ï¼ˆä¼˜åŒ–æ€§èƒ½ï¼‰
export const getMultipleIconsData = (iconNames: string[]): Record<string, IconData | null> => {
  const result: Record<string, IconData | null> = {}

  iconNames.forEach(iconName => {
    result[iconName] = getIconSVGData(iconName)
  })

  return result
}

// 7. å·¥å…·å‡½æ•°ï¼šè·å–æ”¯æŒçš„å›¾æ ‡é›†åˆ—è¡¨
export const getSupportedIconSets = () => {
  return Object.entries(iconSetInfo).map(([prefix, info]) => ({
    prefix,
    name: info.name,
    count: info.count
  }))
}

// 8. å·¥å…·å‡½æ•°ï¼šæ£€æŸ¥å›¾æ ‡æ˜¯å¦å­˜åœ¨
export const isIconAvailable = (iconName: string): boolean => {
  return getIconSVGData(iconName) !== null
}
```

åˆ›å»º `@/components/SmartIcon.vue & IconWrapper.vue`

```vue
<!-- src/components/SmartIcon.vue -->
<template>
  <view
    v-if="isMpWeixin"
    class="smart-icon"
    :class="customClass"
  >
    <!-- è°ƒè¯•ä¿¡æ¯ -->
    <view
      v-if="showDebug"
      class="debug-panel"
    >
      <text class="debug-text">å›¾æ ‡: {{ icon }}</text>
      <text class="debug-text">æ•°æ®: {{ iconData ? 'æœ‰' : 'æ— ' }}</text>
      <text class="debug-text">URLé•¿åº¦: {{ iconSvgUrl?.length || 0 }}</text>
    </view>

    <image
      v-if="iconSvgUrl && !loadError"
      :src="iconSvgUrl"
      class="smart-icon-image"
      :style="imageSizeStyle"
      mode="aspectFit"
      @load="handleImageLoad"
      @error="handleImageError"
    />

    <view
      v-else
      class="icon-error"
      :style="imageSizeStyle"
    >
      <text class="error-text">?</text>
    </view>
  </view>

  <Icon
    v-else
    :icon="icon"
    :width="width"
    :height="height"
    :color="color"
  />
</template>

<script setup lang="ts">
import { getIconSVGData, type IconData } from '@/utils/iconLoader'
import { Icon } from '@iconify/vue'
import { computed, defineProps, onMounted, ref, watch, withDefaults } from 'vue'

const props = withDefaults(
  defineProps<{
    icon: string
    width?: number
    height?: number
    color?: string
    customClass?: string
    showDebug?: boolean
  }>(),
  {
    width: 24,
    height: 24,
    color: '#000000',
    customClass: '',
    showDebug: true,
  },
)

const isMpWeixin = process.env.UNI_PLATFORM === 'mp-weixin'
const iconData = ref<IconData | null>(null)
const isLoading = ref(false)
const loadError = ref(false)

const imageSizeStyle = computed(() => ({
  width: `${props.width}px`,
  height: `${props.height}px`,
}))

const showDebug = computed(() => props.showDebug)

// æ‰‹åŠ¨ Base64 ç¼–ç å‡½æ•°
const manualBase64Encode = (uint8Array: Uint8Array): string => {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/='
  let output = ''

  for (let i = 0; i < uint8Array.length; i += 3) {
    const a = uint8Array[i] ?? 0
    const b = uint8Array[i + 1] || 0
    const c = uint8Array[i + 2] || 0

    const bits = (a << 16) | (b << 8) | c

    output += chars.charAt((bits >> 18) & 0x3f)
    output += chars.charAt((bits >> 12) & 0x3f)
    output += chars.charAt((bits >> 6) & 0x3f)
    output += chars.charAt(bits & 0x3f)
  }

  // æ·»åŠ å¡«å……
  const padding = uint8Array.length % 3
  if (padding === 1) {
    output = output.slice(0, -2) + '=='
  } else if (padding === 2) {
    output = output.slice(0, -1) + '='
  }

  return output
}

// å­—ç¬¦ä¸²è½¬ ArrayBuffer
const stringToArrayBuffer = (str: string): Uint8Array => {
  if (typeof TextEncoder !== 'undefined') {
    const encoder = new TextEncoder()
    return encoder.encode(str)
  } else {
    // é™çº§æ–¹æ¡ˆ
    const buf = new ArrayBuffer(str.length)
    const bufView = new Uint8Array(buf)
    for (let i = 0; i < str.length; i++) {
      bufView[i] = str.charCodeAt(i)
    }
    return bufView
  }
}

// Base64 ç¼–ç å…¼å®¹å‡½æ•°
// ä¿®æ”¹ Base64 ç¼–ç å…¼å®¹å‡½æ•°ï¼Œç§»é™¤å·²å¼ƒç”¨çš„ API æ£€æŸ¥
const base64Encode = (str: string): string => {
  try {
    // ç»Ÿä¸€ä½¿ç”¨æ‰‹åŠ¨ Base64 ç¼–ç ï¼ˆæœ€å¯é ï¼‰
    const uint8Array = stringToArrayBuffer(str)
    return manualBase64Encode(uint8Array)
  } catch (error) {
    console.error('Base64 ç¼–ç å¤±è´¥:', error)
    // é™çº§æ–¹æ¡ˆ
    return manualBase64Encode(new Uint8Array(Array.from(str).map(c => c.charCodeAt(0))))
  }
}

// ä¿®å¤ SVG å†…å®¹æ ¼å¼é—®é¢˜
const iconSvgUrl = computed(() => {
  if (!isMpWeixin || !iconData.value) return ''

  try {
    console.log('ğŸ›  ç”Ÿæˆ SVG Data URL...')

    let svgContent = ''

    // æ£€æŸ¥ iconData.body æ˜¯å®Œæ•´çš„ SVG è·¯å¾„æ ‡ç­¾è¿˜æ˜¯çº¯è·¯å¾„æ•°æ®
    if (iconData.value.body.includes('<path')) {
      // å¦‚æœ body å·²ç»æ˜¯å®Œæ•´çš„ <path> æ ‡ç­¾ï¼Œç›´æ¥ä½¿ç”¨
      console.log('ğŸ“¦ ä½¿ç”¨å®Œæ•´è·¯å¾„æ ‡ç­¾')
      svgContent = `<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" 
     width="${props.width}" 
     height="${props.height}" 
     viewBox="0 0 ${iconData.value.width} ${iconData.value.height}">
  ${iconData.value.body.replace(/fill="currentColor"/g, `fill="${props.color}"`)}
</svg>`
    } else {
      // å¦‚æœ body åªæ˜¯è·¯å¾„æ•°æ®ï¼Œæ„å»ºå®Œæ•´çš„ <path> æ ‡ç­¾
      console.log('ğŸ“¦ æ„å»ºè·¯å¾„æ ‡ç­¾')
      svgContent = `<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" 
     width="${props.width}" 
     height="${props.height}" 
     viewBox="0 0 ${iconData.value.width} ${iconData.value.height}">
  <path fill="${props.color}" d="${iconData.value.body}"/>
</svg>`
    }

    console.log('ğŸ“ SVG å†…å®¹:', svgContent)

    // æ¸…ç† SVGï¼ˆç§»é™¤æ¢è¡Œå’Œå¤šä½™ç©ºæ ¼ï¼‰
    const cleanSvg = svgContent.replace(/\s+/g, ' ').trim()

    // ä½¿ç”¨å…¼å®¹çš„ base64 ç¼–ç 
    const base64Svg = base64Encode(cleanSvg)
    if (!base64Svg) {
      console.error('âŒ Base64 ç¼–ç å¤±è´¥')
      return ''
    }

    const dataUrl = `data:image/svg+xml;base64,${base64Svg}`

    console.log('ğŸ”— ç”Ÿæˆçš„ Data URLï¼ˆå‰100å­—ç¬¦ï¼‰:', dataUrl.substring(0, 100))

    return dataUrl
  } catch (error) {
    console.error('ğŸ’¥ ç”Ÿæˆ SVG Data URL å¤±è´¥:', error)
    return ''
  }
})

// åŠ è½½å›¾æ ‡æ•°æ®
const loadIconData = async () => {
  if (!isMpWeixin) return

  console.log(`ğŸ” åŠ è½½å›¾æ ‡: ${props.icon}`)

  isLoading.value = true
  loadError.value = false
  iconData.value = null

  try {
    const data = getIconSVGData(props.icon)
    console.log('ğŸ“¦ å›¾æ ‡æ•°æ®:', data)

    if (data && data.body) {
      iconData.value = data
      console.log('âœ… å›¾æ ‡æ•°æ®åŠ è½½æˆåŠŸ')

      // è°ƒè¯•ï¼šæ£€æŸ¥ body å†…å®¹ç±»å‹
      if (data.body.includes('<path')) {
        console.log('ğŸ” body åŒ…å«å®Œæ•´è·¯å¾„æ ‡ç­¾')
      } else {
        console.log('ğŸ” body æ˜¯çº¯è·¯å¾„æ•°æ®')
      }
    } else {
      loadError.value = true
      console.warn('âŒ å›¾æ ‡æ•°æ®ä¸ºç©º')
    }
  } catch (error) {
    loadError.value = true
    console.error('ğŸ’¥ åŠ è½½å¼‚å¸¸:', error)
  } finally {
    isLoading.value = false
  }
}

const handleImageLoad = () => {
  console.log('ğŸ‰ å›¾ç‰‡åŠ è½½æˆåŠŸï¼')
  loadError.value = false
}

// eslint-disable-next-line @typescript-eslint/no-explicit-any
const handleImageError = (event: any) => {
  console.error('ğŸ–¼ å›¾ç‰‡åŠ è½½å¤±è´¥:', event)
  console.log('ğŸ”— å¤±è´¥çš„ Data URL:', iconSvgUrl.value)
  loadError.value = true
}

watch(() => props.icon, loadIconData)
onMounted(loadIconData)
</script>

<style scoped>
.smart-icon {
  display: inline-flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.smart-icon-image {
  display: block;
}

.debug-panel {
  background: #f0f0f0;
  padding: 4rpx 8rpx;
  border-radius: 4rpx;
  margin-bottom: 8rpx;
}

.debug-text {
  font-size: 10px;
  color: #666;
  display: block;
}

.icon-error {
  display: flex;
  align-items: center;
  justify-content: center;
  background: #ffebee;
  border-radius: 4px;
}

.error-text {
  font-size: 14px;
  color: #f44336;
}
</style>
```



::: details å…³è”

è¿™ä¸ª `iconLoader.ts` æ–‡ä»¶æ˜¯æ•´ä¸ªå›¾æ ‡ç³»ç»Ÿçš„**æ•°æ®å±‚æ ¸å¿ƒ**ï¼Œå®ƒä¸ SmartIcon ç»„ä»¶çš„å…³ç³»å¦‚ä¸‹ï¼š

æ ¸å¿ƒä½œç”¨

1. **å›¾æ ‡æ•°æ®ä»“åº“**

```ts
// å­˜å‚¨æ‰€æœ‰å›¾æ ‡é›†çš„åŸå§‹æ•°æ®
const iconSets: Record<string, any> = {
  'mdi': mdiIcons,  // åŒ…å« 7000+ Material Design å›¾æ ‡
  'ph': phIcons,     // åŒ…å« 6000+ Phosphor å›¾æ ‡
}
```

- ç›¸å½“äºå›¾æ ‡çš„"æ•°æ®åº“"
- ç®¡ç†å¤šä¸ªå›¾æ ‡é›†çš„åŸå§‹ SVG æ•°æ®

2. **æ•°æ®è§£æå™¨**

```ts
export const getIconSVGData = (iconName: string): IconData | null => {
  const [prefix, name] = iconName.split(':')  // è§£æ "mdi:account-box"
  const iconSet = iconSets[prefix]            // æ‰¾åˆ°å¯¹åº”çš„å›¾æ ‡é›†
  const iconData = getIconData(iconSet, name) // æå–å…·ä½“å›¾æ ‡æ•°æ®
  return { body, width, height }              // è¿”å›æ ‡å‡†åŒ–æ•°æ®
}
```

- å°† `"mdi:account-box"` è¿™æ ·çš„å­—ç¬¦ä¸²è½¬æ¢ä¸ºå…·ä½“çš„ SVG æ•°æ®
- æä¾›ç»Ÿä¸€çš„æ¥å£ç»™ç»„ä»¶å±‚ä½¿ç”¨

ä¸ SmartIcon ç»„ä»¶çš„å…³è”

æ•°æ®æµå…³ç³»ï¼š

text

```ts
SmartIcon ç»„ä»¶ (UIå±‚) 
    â†“ (è¯·æ±‚æ•°æ®)
iconLoader.ts (æ•°æ®å±‚) 
    â†“ (è¿”å›æ•°æ®)
SmartIcon ç»„ä»¶ (æ¸²æŸ“æ˜¾ç¤º)
```



å…·ä½“è°ƒç”¨è¿‡ç¨‹ï¼š

1. **ç»„ä»¶è¯·æ±‚æ•°æ®**ï¼š

```ts
// åœ¨ SmartIcon.vue ä¸­
const loadIconData = async () => {
  const data = getIconSVGData(props.icon)  // è°ƒç”¨ iconLoader
  // data = { body: "<path...>", width: 24, height: 24 }
}
```



1. **æ•°æ®å±‚å¤„ç†**ï¼š

```ts
// iconLoader.ts å¤„ç† "mdi:account-box"
è¾“å…¥: "mdi:account-box"
è¾“å‡º: {
  body: "<path fill="currentColor" d="M6 17c0-2 4-3.1..."/>",
  width: 24,
  height: 24
}
```



1. **ç»„ä»¶æ¸²æŸ“**ï¼š

```ts
// SmartIcon ä½¿ç”¨è¿”å›çš„æ•°æ®ç”Ÿæˆ SVG
const svgContent = `
  <svg ...>
    ${iconData.value.body.replace(/fill="currentColor"/g, `fill="${props.color}"`)}
  </svg>`
```



æ¶æ„ä¼˜åŠ¿

1. **å…³æ³¨ç‚¹åˆ†ç¦»**

- **iconLoader.ts**: åªè´Ÿè´£æ•°æ®ç®¡ç†å’Œè§£æ
- **SmartIcon.vue**: åªè´Ÿè´£ UI æ¸²æŸ“å’Œäº¤äº’

2. **å¯ç»´æŠ¤æ€§**

```ts
// æ·»åŠ æ–°å›¾æ ‡é›†åªéœ€åœ¨è¿™é‡Œæ‰©å±•
const iconSets = {
  'mdi': mdiIcons,
  'ph': phIcons,
  'fa': faIcons,      // æœªæ¥æ‰©å±• FontAwesome
  'antd': antdIcons,  // æœªæ¥æ‰©å±• Ant Design
}
```

3. **é”™è¯¯å¤„ç†**

```ts
// ç»Ÿä¸€çš„æ•°æ®éªŒè¯å’Œé”™è¯¯æç¤º
if (!iconSet) {
  console.warn(`ä¸æ”¯æŒçš„å›¾æ ‡é›†: "${prefix}"`)
}
if (!iconData) {
  console.warn(`å›¾æ ‡ä¸å­˜åœ¨: "${iconName}"`)
}
```

4. **æ€§èƒ½ä¼˜åŒ–**

```ts
// æ”¯æŒæ‰¹é‡è·å–ï¼Œå‡å°‘é‡å¤è§£æ
export const getMultipleIconsData = (iconNames: string[]) => {
  // ä¸€æ¬¡æ€§è·å–å¤šä¸ªå›¾æ ‡æ•°æ®
}
```

å®é™…å·¥ä½œæµç¨‹

å½“ä½ åœ¨ç»„ä»¶ä¸­ä½¿ç”¨ï¼š

```
<SmartIcon icon="mdi:account-box" color="#52c41a" />
```

å®é™…æ‰§è¡Œè¿‡ç¨‹ï¼š

1. ç»„ä»¶è°ƒç”¨ `getIconSVGData("mdi:account-box")`
2. iconLoader è§£æå‡ºå‰ç¼€ `mdi` å’Œå›¾æ ‡å `account-box`
3. åœ¨ mdi å›¾æ ‡é›†ä¸­æŸ¥æ‰¾ `account-box` çš„ SVG æ•°æ®
4. è¿”å›æ ‡å‡†åŒ–çš„ `{ body, width, height }`
5. ç»„ä»¶ç”¨æ­¤æ•°æ®ç”Ÿæˆ SVG Data URL
6. æœ€ç»ˆæ¸²æŸ“ä¸ºå›¾ç‰‡æ˜¾ç¤º

**æ€»ç»“**ï¼š`iconLoader.ts` æ˜¯å›¾æ ‡ç³»ç»Ÿçš„"å¤§è„‘"ï¼Œè´Ÿè´£æ‰€æœ‰å›¾æ ‡æ•°æ®çš„å­˜å‚¨ã€æŸ¥æ‰¾å’Œæ ‡å‡†åŒ–ï¼Œè€Œ `SmartIcon.vue` æ˜¯"å±•ç¤ºå±‚"ï¼Œè´Ÿè´£å°†æ•°æ®æ¸²æŸ“ä¸ºç”¨æˆ·å¯è§çš„å›¾æ ‡ã€‚

:::

::: details åæœŸä½¿ç”¨

ğŸ”§ iconLoader.ts å¿…è¦ä¿®æ”¹

æ­¥éª¤1ï¼šå¯¼å…¥ Weather Icons

```
pnpm add @iconify-json/wi
```



```
// src/utils/iconLoader.ts
import { getIconData } from '@iconify/utils/lib/icon-set/get-icon'

// å¯¼å…¥å›¾æ ‡é›† - æ·»åŠ  wiIcons
import { icons as mdiIcons } from '@iconify-json/mdi'
import { icons as phIcons } from '@iconify-json/ph'
import { icons as wiIcons } from '@iconify-json/wi'  // â† æ–°å¢è¿™è¡Œ
```



æ­¥éª¤2ï¼šé…ç½®å›¾æ ‡é›†æ˜ å°„

```
// é…ç½®æ”¯æŒçš„å›¾æ ‡é›†æ˜ å°„ - æ·»åŠ  wi æ˜ å°„
const iconSets: Record<string, any> = {
  'mdi': mdiIcons,
  'ph': phIcons,
  'wi': wiIcons,  // â† æ–°å¢è¿™è¡Œ
}
```



æ­¥éª¤3ï¼šæ›´æ–°å›¾æ ‡é›†ä¿¡æ¯

```
// å›¾æ ‡é›†ä¿¡æ¯ - æ·»åŠ  wi ä¿¡æ¯
export const iconSetInfo: Record<string, { name: string; count: number }> = {
  'mdi': { name: 'Material Design Icons', count: 7000 },
  'ph': { name: 'Phosphor Icons', count: 6000 },
  'wi': { name: 'Weather Icons', count: 215 },  // â† æ–°å¢è¿™è¡Œ
  // ... å…¶ä»–å›¾æ ‡é›†ä¿¡æ¯
}
```



:::



```vue
<template>
  <view
    v-if="isMpWeixin"
    class="icon-container"
  >
    <image
      :src="iconSvgUrl"
      :style="{ width: width + 'px', height: height + 'px' }"
    />
  </view>
  <Icon
    v-else
    :icon="icon"
    :width="width"
    :height="height"
    :color="color"
  />
</template>

<script setup lang="ts">
import { Icon } from '@iconify/vue'
import { computed, defineProps } from 'vue'

const props = defineProps({
  icon: { type: String, required: true },
  width: { type: Number, default: 30 },
  height: { type: Number, default: 30 },
  color: { type: String, default: '#000' },
})

const isMpWeixin = process.env.UNI_PLATFORM === 'mp-weixin'

// å›¾æ ‡æ•°æ®æ˜ å°„
const iconDataMap: Record<string, { body: string; width: number; height: number }> = {
  'mdi:account-box': {
    body: 'M6 17c0-2 4-3.1 6-3.1s6 1.1 6 3.1v1H6m9-9a3 3 0 0 1-3 3a3 3 0 0 1-3-3a3 3 0 0 1 3-3a3 3 0 0 1 3 3M3 5v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2z',
    width: 24,
    height: 24,
  },
  'ph:user-circle': {
    body: 'M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 3a3 3 0 1 1-3 3a3 3 0 0 1 3-3zm0 14.2a7.2 7.2 0 0 1-6-3.22c.03-1.99 4-3.08 6-3.08c1.99 0 5.97 1.09 6 3.08a7.2 7.2 0 0 1-6 3.22z',
    width: 24,
    height: 24,
  },
}

const iconSvgUrl = computed(() => {
  if (!isMpWeixin) return ''

  const iconData = iconDataMap[props.icon]
  if (!iconData) {
    // å¦‚æœæ‰¾ä¸åˆ°å›¾æ ‡ï¼Œè¿”å›é»˜è®¤çš„åœ†å½¢
    const defaultSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="${props.width}" height="${props.height}">
      <rect width="100%" height="100%" fill="#f0f0f0"/>
      <circle cx="50%" cy="50%" r="40%" fill="${props.color}"/>
    </svg>`
    return 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(defaultSvg)
  }

  // ä½¿ç”¨çœŸå®çš„å›¾æ ‡æ•°æ®
  const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${props.width}" height="${props.height}" viewBox="0 0 ${iconData.width} ${iconData.height}">
    <path fill="${props.color}" d="${iconData.body}"/>
  </svg>`

  return 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg)
})
</script>

<style scoped>
.icon-container {
  display: flex;
  flex-direction: column;
  align-items: center;
}
</style>
```

åç»­ï¼Œæ¥ç€å¥ä¹ï¼Œæ¥ç€èˆ..

```
# å®‰è£…å¿…è¦çš„ä¾èµ–ï¼Œå…¶ä¸­
pnpm add @iconify/vue @iconify/json
```

- `@iconify/json` åŒ…å«å®Œæ•´å›¾æ ‡æ•°æ®

- å¯ä»¥åœ¨è¿è¡Œæ—¶è·å– SVG Path / Data URL

::: details å‘ä½

å‘ä½ï¼šTypeScript åœ¨ **å‰ç«¯é¡¹ç›®é‡Œè¯†åˆ«ä¸äº† Node.js çš„ `process` å…¨å±€å˜é‡**ã€‚åœ¨ uni-app / Vite é¡¹ç›®ä¸­å¸¸è§ï¼Œå°¤å…¶ä½ å†™äº†ï¼š

```
const isMpWeixin = process.env.UNI_PLATFORM === 'mp-weixin'
```

------

è§£å†³æ–¹æ³•

1ï¸âƒ£ å®‰è£… Node ç±»å‹

```
pnpm add -D @types/node # å®æµ‹æ— éœ€å®‰è£…å®ƒ
# æˆ– npm i -D @types/node
```

------

2ï¸âƒ£ tsconfig.json é…ç½®

åœ¨ `tsconfig.json` çš„ `compilerOptions` ä¸­æ·»åŠ ï¼š

```
{
  "compilerOptions": {
    "types": ["vite/client", "node"]
  }
}
```

- `vite/client` â†’ è¯†åˆ« Vite å…¨å±€ç±»å‹
- `node` â†’ è¯†åˆ« `process`ã€`Buffer` ç­‰ Node å…¨å±€å˜é‡

:::

ä¸º JSON åˆ›å»ºç±»å‹å£°æ˜

åœ¨ `types/iconify-json.d.ts` ä¸­æ·»åŠ ï¼š

```
declare module '@iconify-json/mdi/icons' {
  const icons: Record<string, { body: string; width: number; height: number }>
  export = icons
}

declare module '@iconify-json/ph/icons' {
  const icons: Record<string, { body: string; width: number; height: number }>
  export = icons
}
```

- è®© TS å’Œ Vite éƒ½èƒ½è¯†åˆ« JSON æ¨¡å—
- æŒ‰éœ€å¯¼å…¥æ—¶ä¸ä¼šæŠ¥é”™

# å…³äºvueæ–‡ä»¶è¡Œå†…æ ·å¼æ¢è¡Œçš„å°å‘

éœ€è¦åœ¨ settings.json å½“ä¸­æ˜ç¡®æŒ‡å®š vue æ–‡ä»¶çš„æ ¼å¼åŒ–å·¥å…·ï¼š

```json
{
  // ä¿å­˜æ—¶è‡ªåŠ¨æ ¼å¼åŒ–
  "editor.formatOnSave": true,
  // å¯ç”¨ ESLint Flat Config
  "eslint.useFlatConfig": true,
  // "editor.defaultFormatter": "dbaeumer.vscode-eslint",
  // æ–‡ä»¶æ ¼å¼åŒ–é…ç½®
  "[json]": {
    // "editor.defaultFormatter": "vscode.json-language-features"
    // ä½†å®é™…ä¸Šï¼Œå› ä¸º eslint.validate ä¸åŒ…å« jsonï¼ŒESLint ä¸ä¼šå¤„ç†æ™®é€š JSON æ–‡ä»¶
    // æ‰€ä»¥ä¿å­˜æ—¶ä¼šå›é€€åˆ° VSCode å†…ç½®çš„ JSON æ ¼å¼åŒ–å™¨
    // "editor.defaultFormatter": "dbaeumer.vscode-eslint"
  },
  "[jsonc]": {
    // åªè°ƒç”¨ VSCode å†…ç½®çš„ JSON/JSONC æ ¼å¼åŒ–å™¨ã€‚
    // "editor.defaultFormatter": "vscode.json-language-features",
    //
    "editor.defaultFormatter": "dbaeumer.vscode-eslint",
    "editor.tabSize": 4,
    "editor.insertSpaces": true
  },
  // ESLint æ ¡éªŒèŒƒå›´
  "eslint.validate": ["javascript", "vue", "jsonc"],
  // é…ç½®è¯­è¨€çš„æ–‡ä»¶å…³è”
  "files.associations": {
    "pages.json": "jsonc",
    "manifest.json": "jsonc"
  },
  "typescript.tsdk": "node_modules\\typescript\\lib",

  // --- æ–°å¢é…ç½®ï¼šåªé’ˆå¯¹ Vue/JS ä½¿ç”¨ Prettier ---  // [!code ++]
  "[vue]": { // [!code ++]
    "editor.defaultFormatter": "dbaeumer.vscode-eslint" // [!code ++]
  }, // [!code ++]
  "[javascript]": { // [!code ++]
    "editor.defaultFormatter": "dbaeumer.vscode-eslint" // [!code ++]
  }, // [!code ++]
  "editor.codeActionsOnSave": { // [!code ++]
    "source.fixAll.eslint": "explicit", // [!code ++]
    "source.organizeImports": "explicit" // [!code ++]
  } // [!code ++]
} // [!code ++]
```

::: details å…·ä½“è¯´æ˜

ğŸ§© ç°è±¡èƒŒåçš„é€»è¾‘é“¾

æ–°å¢çš„è¿™æ®µé…ç½®ï¼š

```json
// --- æ–°å¢é…ç½®ï¼šåªé’ˆå¯¹ Vue/JS ä½¿ç”¨ Prettier ---
"[vue]": {
  "editor.defaultFormatter": "dbaeumer.vscode-eslint"
},
"[javascript]": {
  "editor.defaultFormatter": "dbaeumer.vscode-eslint"
},
"editor.codeActionsOnSave": {
  "source.fixAll.eslint": "explicit",
  "source.organizeImports": "explicit"
}
```

è®© VS Code æ˜ç¡®åœ°æ‰§è¡Œäº† **â€œç”± ESLint è´Ÿè´£æ ¼å¼åŒ–â€** è¿™ä¸€è¡Œä¸ºã€‚
 äºæ˜¯ï¼Œâ€œé—ªè·³â€å°±æ¶ˆå¤±äº†ã€‚ä¸ºä»€ä¹ˆï¼ŸğŸ‘‡

------

âš™ï¸ åŸç†åˆ†æï¼ˆå…³é”®ç‚¹åœ¨ VS Code çš„è¡Œä¸ºä¼˜å…ˆçº§ï¼‰

å½“ä½ ä¿å­˜æ–‡ä»¶æ—¶ï¼ŒVS Code å¯èƒ½è§¦å‘å¤šä¸ªã€Œæ ¼å¼åŒ–æ¥æºã€ï¼š

| ä¼˜å…ˆçº§ | æ¥æº                                            | è§¦å‘æ¡ä»¶                         |
| ------ | ----------------------------------------------- | -------------------------------- |
| 1ï¸âƒ£      | ä½ æ˜¾å¼æŒ‡å®šçš„ `editor.defaultFormatter`          | ä¼˜å…ˆæœ€é«˜ï¼ˆå½“å‰ç”Ÿæ•ˆï¼‰             |
| 2ï¸âƒ£      | è¯­è¨€æœåŠ¡å™¨ï¼ˆå¦‚ Volar/Veturï¼‰å†…ç½®çš„æ ¼å¼åŒ–        | å½“æœªæŒ‡å®š defaultFormatter æ—¶è§¦å‘ |
| 3ï¸âƒ£      | ESLint æ‰§è¡Œçš„è‡ªåŠ¨ä¿®å¤ï¼ˆ`source.fixAll.eslint`ï¼‰ | å½“ä¿å­˜æ—¶å¯ç”¨ Code Actions        |
| 4ï¸âƒ£      | å…¶ä»–æ‰©å±•æˆ–å†…ç½® formatterï¼ˆå¦‚ Prettier æ’ä»¶ï¼‰    | å½“ VS Code æœªæ˜ç¡®æŒ‡æ´¾æ—¶è§¦å‘      |

------

ğŸ§  åŸå§‹çŠ¶æ€ï¼ˆæœ‰â€œé—ªè·³â€ï¼‰æ˜¯è¿™æ ·ï¼š

1. ä½ ç¦ç”¨äº† Prettier æ‰©å±• âœ…
2. ä½† VS Code æœªæ˜ç¡®æŒ‡å®šè°æ˜¯ formatter âŒ
3. Volarï¼ˆæˆ– JS è¯­è¨€æœåŠ¡ï¼‰å‘ç°æ²¡æœ‰é»˜è®¤ formatterï¼Œäºæ˜¯è°ƒç”¨äº† Prettier å†…éƒ¨é€»è¾‘æ ¼å¼åŒ–
4. ç´§æ¥ç€ ESLintï¼ˆé€šè¿‡ fixAllï¼‰å†ä¿®å¤ â†’ â€œé—ªè·³â€ç°è±¡å‡ºç°

> ğŸŒ€ **ç»“æœï¼šä¸¤ä¸ªä¸åŒçš„ formatter æ¥è¿ä¿®æ”¹åŒä¸€ä¸ªæ–‡ä»¶ã€‚**

------

âœ¨ ä½ çš„æ–°é…ç½®ä¿®å¤äº†å†²çªçš„åŸå› 

å½“ä½ åŠ ä¸Šï¼š

```
"[vue]": { "editor.defaultFormatter": "dbaeumer.vscode-eslint" }
```

VS Code æ˜ç¡®å‘Šè¯‰è‡ªå·±ï¼š

> ã€Œä¿å­˜ .vue æ–‡ä»¶æ—¶ï¼Œåªè°ƒç”¨ ESLint ä¿®å¤ï¼Œä¸ä½¿ç”¨å…¶ä»– formatterã€‚ã€

äºæ˜¯æµç¨‹å˜æˆï¼š

```
ä¿å­˜æ–‡ä»¶ â†’
ä»…æ‰§è¡Œ ESLint çš„ fixAll â†’
eslint-plugin-prettier åœ¨ ESLint å†…éƒ¨è°ƒç”¨ prettier æ ¼å¼åŒ– â†’
ç»“æœä¸€æ¬¡å®Œæˆï¼Œæ— äºŒæ¬¡è¦†ç›–
```

------

âœ… ç»“è®ºæ€»ç»“

| é¡¹ç›®çŠ¶æ€                             | æ ¼å¼åŒ–æ¥æº              | æ˜¯å¦å†²çª   | è¯´æ˜         |
| ------------------------------------ | ----------------------- | ---------- | ------------ |
| æœªæŒ‡å®š formatter                     | Volar + ESLint          | âš ï¸ é—ªè·³     | ä¸¤è€…éƒ½æ ¼å¼åŒ– |
| æŒ‡å®š `dbaeumer.vscode-eslint`        | ESLintï¼ˆè°ƒç”¨ Prettierï¼‰ | âœ… æ— å†²çª   | ç»Ÿä¸€æ§åˆ¶     |
| å¯ç”¨ Prettier æ‰©å±•ä½†ä¸ç¦ ESLint      | ESLint + Prettier æ‰©å±•  | âš ï¸ é—ªè·³     | ä¸¤å¥—ç³»ç»Ÿç«äº‰ |
| å®Œå…¨ç¦ç”¨ Prettier æ‰©å±• + æŒ‡å®š ESLint | ESLintï¼ˆå†…ç½® Prettierï¼‰ | ğŸŸ¢ ç†æƒ³çŠ¶æ€ | æ¨èå›¢é˜Ÿä½¿ç”¨ |

------

ğŸ’¡ **æ€»ç»“ä¸€å¥è¯ï¼š**

> ä½ è¿™æ®µé…ç½®çš„æœ¬è´¨ä½œç”¨ï¼Œæ˜¯è®© VS Code çš„ã€Œæ ¼å¼åŒ–è¡Œä¸ºã€**å®Œå…¨ç”± ESLint æ¥ç®¡**ï¼Œ
>  è€Œ ESLint å†é€šè¿‡ `eslint-plugin-prettier` å†…éƒ¨è°ƒç”¨ Prettier å®ç°ä¸€è‡´çš„æ ¼å¼åŒ–ã€‚
>  ä»æ­¤ VS Codeã€Prettierã€ESLint ä¸å†æ‰“æ¶ï¼Œä¸€åˆ‡å½’äºç»Ÿä¸€ã€‚ğŸ‘

:::



# uni-icon è¡Œå†…æ ·å¼çš„è¦†å†™

ç»„ä»¶æ ·å¼ä¼šå½±å“ä¸ä¹‹ç›¸é‚»çš„æ ‡ç­¾æˆ–æ–‡å­—ï¼Œä½¿ä¸¤è€…ä¸åœ¨åŒä¸€æ°´å¹³çº¿ä¸Šå› æ­¤éœ€è¦è¡Œå†…è¦†å†™ï¼š

```html
<view class="right-info">
  <uni-icons
    type="location"
    size="24"
    style="margin-left: -10rpx"
  ></uni-icons>
  <view>
    {{ greenhouse.name }}
  </view>
</view>
```

